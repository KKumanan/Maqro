(()=>{"use strict";const e={apiEndpoint:"http://localhost:3000/api/events",isCollecting:!0},o="maqroUserEvents",t="maqroBatchSendAlarm",n=chrome.storage.local.QUOTA_BYTES||5242880;let s=!1;async function a(){if(s)console.log("Maqro: Batch send already in progress. Skipping.");else{s=!0;try{const t=(await chrome.storage.local.get(o))[o]||[];if(0===t.length)return console.log("Maqro: No events to send."),void(s=!1);console.log(`Maqro: Attempting to send batch of ${t.length} events.`);const n=await fetch(e.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:t})});if(!n.ok)throw new Error(`API responded with status: ${n.status} ${await n.text()}`);const a=await n.json();console.log("Maqro: Event batch sent successfully",a),await chrome.storage.local.remove(o),console.log("Maqro: Local events cleared after successful send.")}catch(e){console.error("Maqro: Error sending event batch:",e.message,e.stack)}finally{s=!1}}}chrome.runtime.onInstalled.addListener((()=>{console.log("Maqro: Extension installed/updated. Setting up alarm."),chrome.alarms.get(t,(e=>{e?console.log("Maqro: Batch send alarm already exists."):(chrome.alarms.create(t,{periodInMinutes:5}),console.log("Maqro: Batch send alarm created."))}))})),chrome.alarms.get(t,(e=>{e||(console.log("Maqro: Alarm not found on startup, creating."),chrome.alarms.create(t,{periodInMinutes:5}))})),chrome.alarms.onAlarm.addListener((e=>{e.name===t&&(console.log("Maqro: Batch send alarm triggered."),a())})),chrome.runtime.onMessage.addListener(((t,s,r)=>{var l;console.log("Maqro: Received message",t),"USER_EVENT"===t.type&&t.event?async function(t){if(e.isCollecting)try{const e=(await chrome.storage.local.get(o))[o]||[];e.push(t),await chrome.storage.local.set({[o]:e}),console.log("Maqro: Event stored locally. Total stored:",e.length),chrome.storage.local.getBytesInUse([o],(e=>{chrome.runtime.lastError?console.error("Maqro: Error getting bytes in use:",chrome.runtime.lastError.message):(console.log(`Maqro: Storage used for events: ${e} bytes / ${n} bytes`),e/n>.8&&(console.log("Maqro: Storage limit threshold reached. Triggering early batch send."),a()))}))}catch(e){console.error("Maqro: Error storing event locally",e)}else console.log("Maqro: Event collection is paused (handleUserEvent)")}(t.event):"TOGGLE_COLLECTION"===t.type&&(e.isCollecting=null!==(l=t.enabled)&&void 0!==l&&l,console.log("Maqro: Collection state changed to",e.isCollecting),r({success:!0}),e.isCollecting||(console.log("Maqro: Collection stopped, attempting to send any pending events."),a()))})),chrome.tabs.onUpdated.addListener(((o,t,n)=>{var s;"complete"===t.status&&(null===(s=n.url)||void 0===s?void 0:s.startsWith("http"))&&(console.log("Maqro: Injecting content script into tab",o),chrome.scripting.executeScript({target:{tabId:o},files:["content.js"]}).then((()=>{console.log("Maqro: Content script injected successfully"),chrome.tabs.sendMessage(o,{type:"TOGGLE_COLLECTION",enabled:e.isCollecting})})).catch((e=>{console.error("Maqro: Error injecting content script",e)})))})),chrome.action.onClicked.addListener((o=>{o.id&&(chrome.tabs.sendMessage(o.id,{type:"TOGGLE_COLLECTION",enabled:!e.isCollecting}),e.isCollecting=!e.isCollecting)})),chrome.idle.onStateChanged.addListener((o=>{console.log("Maqro: Idle state changed to",o),"idle"===o?e.isCollecting=!1:"active"===o&&(e.isCollecting=!0)})),chrome.windows.onFocusChanged.addListener((o=>{console.log("Maqro: Window focus changed to",o),o===chrome.windows.WINDOW_ID_NONE?e.isCollecting=!1:e.isCollecting=!0}))})();
//# sourceMappingURL=background.js.map