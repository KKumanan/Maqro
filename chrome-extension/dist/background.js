(()=>{"use strict";const e={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let t;const n=new Uint8Array(16);function o(){if(!t&&(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!t))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(n)}const s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));const r=function(t,n,r){if(e.randomUUID&&!n&&!t)return e.randomUUID();const a=(t=t||{}).random||(t.rng||o)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,n){r=r||0;for(let e=0;e<16;++e)n[r+e]=a[e];return n}return function(e,t=0){return s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]}(a)};var a;function i(e){const t=function(e){const t=e.reduce(((e,t)=>(e[t.event_type]=(e[t.event_type]||0)+1,e)),{}),n=[];return t[a.CLICK]&&n.push(`${t[a.CLICK]} Click${t[a.CLICK]>1?"s":""}`),t[a.FOCUS]&&n.push(`${t[a.FOCUS]} Focus${t[a.FOCUS]>1?"es":""}`),t[a.SCROLL]&&n.push(`${t[a.SCROLL]} Scroll${t[a.SCROLL]>1?"s":""}`),n.join(" + ")}(e.events),n=(o=e.events,s=e.domain,`Automates ${o.map((e=>{switch(e.event_type){case a.CLICK:return`click on ${e.selector||"element"}`;case a.FOCUS:return`focus ${e.state}`;case a.SCROLL:return`scroll to ${e.scrollY}px`;default:return e.event_type}})).join(" â†’ ")} in ${s}`);var o,s;return{id:r(),title:t,description:n,keybind:"",isApproved:!1,applications:[e.domain],steps:e.events.map((t=>({app:e.domain,action:t.event_type,args:{selector:t.selector,scrollY:t.scrollY,state:t.state}})))}}function c(e){const t=[];for(let n=2;n<=5;n++)for(let o=0;o<=e.length-n;o++){const s=e.slice(o,o+n),r=JSON.stringify(s);let a=1;for(let t=o+n;t<=e.length-n;t++){const o=e.slice(t,t+n);JSON.stringify(o)===r&&a++}a>=3&&t.push({events:s,frequency:a})}return t}function l(e){return(Math.min(e.frequency/5,1)+Math.min(e.events.length/5,1))/2}!function(e){e.PAGE_VIEW="page_view",e.SCROLL="scroll",e.CLICK="click",e.FOCUS="focus"}(a||(a={}));const u="maqroUserEvents",d="maqroSuggestedMacros",g="maqroBatchSendAlarm",h="maqroKeepaliveAlarm",m="maqroPatternAnalysisAlarm",p={isCollecting:!0,userManuallyPaused:!1,isSendingBatch:!1,lastSendAttempt:0,sendFailureCount:0,totalEventsSent:0,totalEventsDropped:0};function f(e,t,...n){"error"===e&&console[e]("Maqro:",t,...n)}function C(e){return(new TextEncoder).encode(JSON.stringify(e)).length}async function y(){if(p.isSendingBatch)f("info","Batch send already in progress. Skipping.");else{p.isSendingBatch=!0,p.lastSendAttempt=Date.now();try{const e=(await chrome.storage.local.get(u))[u]||[];if(0===e.length)return void f("info","No events to send.");const t=function(e){const t=[];let n=[],o=0;for(const s of e){const e=C([s]);(n.length>=50||o+e>102400)&&n.length>0&&(t.push(n),n=[],o=0),n.push(s),o+=e}return n.length>0&&t.push(n),t}(e);f("info",`Sending ${e.length} events in ${t.length} chunks`);let n=0,o=0;for(let e=0;e<t.length;e++){const s=t[e];await v(s,e+1,t.length)?(n++,p.totalEventsSent+=s.length):(o++,p.totalEventsDropped+=s.length)}0===o?(await chrome.storage.local.remove(u),f("info",`All ${n} chunks sent successfully. Storage cleared.`),p.sendFailureCount=0):(f("error",`${o}/${t.length} chunks failed. Keeping events in storage.`),p.sendFailureCount++)}catch(e){f("error","Error in batch send process:",e),p.sendFailureCount++}finally{p.isSendingBatch=!1}}}async function v(e,t,n){let o=0;for(;o<3;)try{const o=JSON.stringify({events:e});f("info",`Sending chunk ${t}/${n} (${e.length} events, ${o.length} bytes)`);const s=await fetch("http://localhost:3000/api/events",{method:"POST",headers:{"Content-Type":"application/json"},body:o,signal:AbortSignal.timeout(1e4)});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e}`)}return f("info",`Chunk ${t}/${n} sent successfully`),!0}catch(e){if(o++,"AbortError"===e.name)f("error",`Chunk ${t} timeout (attempt ${o})`);else{if(e.message.includes("413"))return f("error",`Chunk ${t} too large (413 error). This chunk will be dropped.`),!1;f("error",`Chunk ${t} failed (attempt ${o}):`,e.message)}o<3&&await new Promise((e=>setTimeout(e,1e3*o)))}return f("error",`Chunk ${t} failed after 3 attempts`),!1}async function E(e){try{const t=await chrome.tabs.query({url:["http://*/*","https://*/*"],status:"complete"});f("info",`Broadcasting collection state (${e}) to ${t.length} tabs`);const n=t.filter((e=>e.id)).map((t=>chrome.tabs.sendMessage(t.id,{type:"TOGGLE_COLLECTION",enabled:e}).catch((()=>{}))));await Promise.allSettled(n)}catch(e){f("error","Error broadcasting to tabs:",e)}}async function S(){f("info","Initializing Maqro extension...");const e=[{name:g,periodInMinutes:2},{name:h,periodInMinutes:1},{name:m,periodInMinutes:30}];for(const t of e)await chrome.alarms.get(t.name)||(await chrome.alarms.create(t.name,{periodInMinutes:t.periodInMinutes}),f("info",`Created ${t.name} alarm`));p.isCollecting=!0,p.userManuallyPaused=!1,await E(p.isCollecting),f("info","Extension initialization complete")}chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.type){case"USER_EVENT":e.event&&(async function(e){if(p.isCollecting)try{let t=(await chrome.storage.local.get(u))[u]||[];if(t.length>=1e3){const e=t.length-1e3+1;t=t.slice(e),p.totalEventsDropped+=e,f("warn",`Dropped ${e} old events to prevent memory bloat`)}t.push(e),await chrome.storage.local.set({[u]:t}),function(e){if(e.length>=50)return f("info","Event count threshold reached. Triggering send."),void y();chrome.storage.local.getBytesInUse([u],(e=>{if(chrome.runtime.lastError)return void f("error","Error checking storage usage:",chrome.runtime.lastError.message);const t=e/(chrome.storage.local.QUOTA_BYTES||5242880);t>.7&&(f("info",`Storage threshold reached (${Math.round(100*t)}%). Triggering send.`),y())}))}(t)}catch(e){f("error","Error storing event:",e)}}(e.event),n({success:!0}));break;case"TOGGLE_COLLECTION":return"boolean"==typeof e.enabled&&(p.userManuallyPaused=!e.enabled,p.isCollecting=e.enabled,f("info",`Collection ${p.isCollecting?"enabled":"disabled"} by user`),E(p.isCollecting),n({success:!0,isCollecting:p.isCollecting}),p.isCollecting||y()),!0;case"GET_OPERATIONAL_STATE":return n({success:!0,isCollecting:p.isCollecting,stats:{totalEventsSent:p.totalEventsSent,totalEventsDropped:p.totalEventsDropped,sendFailureCount:p.sendFailureCount}}),!0;case"HEALTH_CHECK":return n({success:!0,isAlive:!0}),!0}})),chrome.runtime.onInstalled.addListener(S),chrome.runtime.onStartup.addListener(S),chrome.alarms.onAlarm.addListener((e=>{switch(e.name){case g:f("info","Batch send alarm triggered"),y();break;case h:break;case m:f("info","Pattern analysis alarm triggered"),async function(){try{const e=(await chrome.storage.local.get(u))[u]||[];if(0===e.length)return void f("info","No events to analyze for patterns.");const t=await async function(e){try{const t=e.reduce(((e,t)=>{const n=new URL(t.url).hostname;return e[n]||(e[n]=[]),e[n].push(t),e}),{}),n=[];for(const[e,o]of Object.entries(t))c(o.sort(((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime()))).forEach((t=>{n.push({events:t.events,frequency:t.frequency,confidence:l(t),domain:e})}));return function(e){return e.filter((e=>e.confidence>.7&&e.frequency>3)).map(i)}(n)}catch(e){return console.error("Error processing events:",e),[]}}(e);if(t.length>0){const e=(await chrome.storage.local.get(d))[d]||[],n=[...e];for(const o of t)e.some((e=>e.title===o.title&&e.applications[0]===o.applications[0]))||n.push(o);await chrome.storage.local.set({[d]:n}),f("info",`Added ${t.length} new macro suggestions.`)}}catch(e){f("error","Error analyzing patterns:",e)}}()}})),chrome.tabs.onUpdated.addListener(((e,t,n)=>{var o;"complete"!==t.status||!(null===(o=n.url)||void 0===o?void 0:o.startsWith("http"))||n.url.includes("chrome://")||n.url.includes("chrome-extension://")||setTimeout((()=>{chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]}).then((()=>{f("info",`Content script injected into tab ${e}`),setTimeout((()=>{chrome.tabs.sendMessage(e,{type:"TOGGLE_COLLECTION",enabled:p.isCollecting}).catch((t=>{t.message.includes("Could not establish connection")||t.message.includes("receiving end does not exist")||f("warn",`Failed to send initial state to tab ${e}: ${t.message}`)}))}),500)})).catch((t=>{t.message.includes("Cannot access")||t.message.includes("The extensions gallery cannot be scripted")||f("warn",`Content script injection failed for tab ${e}: ${t.message}`)}))}),200)})),chrome.action.onClicked.addListener((()=>{const e=!p.isCollecting;p.userManuallyPaused=!e,p.isCollecting=e,f("info","Extension toggled: "+(e?"ON":"OFF")),E(p.isCollecting),p.isCollecting||y()})),chrome.idle.onStateChanged.addListener((e=>{if(!p.userManuallyPaused){const t="active"===e;p.isCollecting!==t&&(p.isCollecting=t,E(p.isCollecting))}})),chrome.windows.onFocusChanged.addListener((e=>{if(!p.userManuallyPaused){const t=e!==chrome.windows.WINDOW_ID_NONE;p.isCollecting!==t&&(p.isCollecting=t,E(p.isCollecting))}}))})();
//# sourceMappingURL=background.js.map