(()=>{"use strict";var e;if(function(e){e.PAGE_VIEW="page_view",e.SCROLL="scroll",e.CLICK="click",e.FOCUS="focus"}(e||(e={})),window.maqroContentScriptLoaded)throw new Error("Maqro content script already loaded");window.maqroContentScriptLoaded=!0;const t={isCollecting:!0,isHealthy:!1,isInitialized:!1,pageLoadTime:Date.now(),lastScrollTime:0,eventsSent:0,eventsDropped:0,connectionFailures:0,localEventQueue:[],lastContextCheck:0};function i(e,t,...i){"error"===e&&console[e]("Maqro:",t,...i)}function n(){var e;try{return!!(null===(e=null===chrome||void 0===chrome?void 0:chrome.runtime)||void 0===e?void 0:e.id)}catch(e){return!1}}function o(t){switch(t){case e.SCROLL:return Math.random()<.1;case e.CLICK:return Math.random()<1;default:return!0}}const a=new WeakMap;function r(e){if(a.has(e))return a.get(e);let t;return t=e.id?`#${e.id}`:e.classList.length>0?`.${Array.from(e.classList).slice(0,3).join(".")}`:e.getAttribute("data-testid")?`[data-testid="${e.getAttribute("data-testid")}"]`:e.getAttribute("href")?`[href*="${e.getAttribute("href").substring(0,20)}"]`:e.tagName.toLowerCase(),a.set(e,t),t}function s(e){return t.isInitialized&&t.isCollecting&&t.isHealthy?n()?(t.localEventQueue.push(e),void(t.localEventQueue.length>=10&&l())):(t.isHealthy=!1,t.eventsDropped++,void i("warn","Context invalid, dropping event")):void t.eventsDropped++}function l(){if(0===t.localEventQueue.length||!t.isHealthy||!t.isInitialized)return;const e=[...t.localEventQueue];t.localEventQueue=[],c(e)}async function c(e,o=0){if(!n())return i("warn","Extension context invalidated, dropping events"),t.eventsDropped+=e.length,t.isHealthy=!1,void(t.isInitialized=!1);try{for(const t of e)await d(t);t.eventsSent+=e.length,t.connectionFailures=0}catch(n){o<3?(i("warn",`Retry ${o+1} for ${e.length} events:`,n.message),setTimeout((()=>{c(e,o+1)}),1e3*(o+1))):(i("error",`Failed to send ${e.length} events after 3 retries`),t.eventsDropped+=e.length)}}function d(e){return new Promise(((i,o)=>{if(n())try{chrome.runtime.sendMessage({type:"USER_EVENT",event:e},(e=>{if(chrome.runtime.lastError){const e=chrome.runtime.lastError.message||"Unknown error";e.includes("Extension context invalidated")||e.includes("message port closed")||e.includes("receiving end does not exist")||e.includes("Could not establish connection")?(t.isHealthy=!1,t.isInitialized=!1,t.connectionFailures++,o(new Error("Connection lost: "+e))):o(new Error(e))}else i()}))}catch(e){o(new Error("Send exception: "+e.message))}else o(new Error("Context invalidated before send"))}))}function u(){if(!t.isInitialized||!t.isHealthy)return void i("warn","Skipping page view tracking - not ready");const n={event_type:e.PAGE_VIEW,url:window.location.href,title:document.title,duration:0,timestamp:(new Date).toISOString()};s(n);const o=()=>{t.isInitialized&&t.isHealthy&&(n.duration=Math.floor((Date.now()-t.pageLoadTime)/1e3),s(n),l())};window.addEventListener("beforeunload",o),window.addEventListener("pagehide",o),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState&&o()}))}document.addEventListener("click",(i=>{if(!t.isInitialized||!t.isHealthy||!t.isCollecting)return;if(!o(e.CLICK))return;if(!n())return void(t.isHealthy=!1);const a=i.target;s({event_type:e.CLICK,url:window.location.href,selector:r(a),x:i.clientX,y:i.clientY,timestamp:(new Date).toISOString()})}),{passive:!0});let h=null;async function m(){return n()?new Promise((e=>{const n=setTimeout((()=>{t.isHealthy=!1,e(!1)}),5e3);try{chrome.runtime.sendMessage({type:"HEALTH_CHECK"},(o=>{clearTimeout(n),chrome.runtime.lastError?(t.isHealthy=!1,i("warn","Health check failed:",chrome.runtime.lastError.message),e(!1)):(t.isHealthy=!0,t.lastContextCheck=Date.now(),e(!0))}))}catch(o){clearTimeout(n),t.isHealthy=!1,i("error","Health check exception:",o.message),e(!1)}})):(t.isHealthy=!1,t.isInitialized=!1,!1)}async function v(){i("info","Maqro content script initializing..."),await new Promise((e=>setTimeout(e,100)));const e=setTimeout((()=>{t.isInitialized||(i("error","Initialization timeout - running in degraded mode"),t.isHealthy=!1,t.isInitialized=!1)}),1e4);await m()?(t.isInitialized=!0,clearTimeout(e),u(),i("info","Content script initialized successfully")):(i("warn","Initial health check failed, retrying in 2 seconds..."),setTimeout((async()=>{await m()?(t.isInitialized=!0,clearTimeout(e),u(),i("info","Content script initialized on retry")):(clearTimeout(e),i("error","Content script initialization failed - running in degraded mode"),t.isInitialized=!1,t.isHealthy=!1)}),2e3)),function(){const e=async()=>{Date.now()-t.lastContextCheck<5e3||(!t.isHealthy&&t.connectionFailures>2?(i("info","Attempting health check recovery..."),await m()&&(i("info","Health check recovery successful"),t.connectionFailures=0,t.isInitialized=!0)):await m())};setInterval(e,3e4),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&setTimeout(e,1e3)}))}(),setInterval((()=>{t.localEventQueue.length>0&&t.isHealthy&&t.isInitialized&&l()}),1e4)}document.addEventListener("scroll",(()=>{if(!t.isInitialized||!t.isHealthy||!o(e.SCROLL))return;const i=Date.now();i-t.lastScrollTime<500||(t.lastScrollTime=i,h&&cancelAnimationFrame(h),h=requestAnimationFrame((()=>{t.isInitialized&&t.isHealthy&&n()&&s({event_type:e.SCROLL,url:window.location.href,scrollY:window.scrollY,timestamp:(new Date).toISOString()})})))}),{passive:!0}),window.addEventListener("focus",(()=>{t.isInitialized&&t.isHealthy&&s({event_type:e.FOCUS,url:window.location.href,state:"focus",timestamp:(new Date).toISOString()})}),{passive:!0}),window.addEventListener("blur",(()=>{t.isInitialized&&t.isHealthy&&(s({event_type:e.FOCUS,url:window.location.href,state:"blur",timestamp:(new Date).toISOString()}),l())}),{passive:!0}),chrome.runtime.onMessage.addListener(((e,n,o)=>{var a;if("TOGGLE_COLLECTION"===e.type)return t.isCollecting=null!==(a=e.enabled)&&void 0!==a&&a,i("info","Collection "+(t.isCollecting?"enabled":"disabled")),t.isCollecting||l(),o({success:!0}),!0})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",v):v(),window.addEventListener("beforeunload",(()=>{t.isHealthy&&t.isInitialized&&l()})),window.addEventListener("beforeunload",(()=>{window.maqroContentScriptLoaded=!1}))})();
//# sourceMappingURL=content.js.map